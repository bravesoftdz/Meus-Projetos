SELECT P.CD_PRODUTO, P.DS_PRODUTO, G.CD_COR, G.CD_TAMANHO, M.DT_MOVIM,
       M.CD_LOJA ,SUM(COALESCE(M.QT_PRODUTO,0))QT_PRODUTO
  FROM PRODUTO P
  LEFT JOIN GRADE G
    ON (G.CD_PRODUTO = P.CD_PRODUTO)
  LEFT JOIN(SELECT M.CD_PRODUTO, M.CD_COR, M.CD_TAMANHO, M.DT_MOVIM,
      		 M.CD_LOJA, 
       		 CASE WHEN M.TP_OPERAC = 'S' THEN M.QT_PRODUTO * -1 
   		    	      WHEN M.TP_OPERAC = 'E' THEN M.QT_PRODUTO END QT_PRODUTO
  		  FROM MOVITEM M
		 WHERE M.TP_OPERAC <> 'T'
		   AND COALESCE(M.FL_MOVEST,'N') <> 'C'
		 UNION ALL
		SELECT M.CD_PRODUTO, M.CD_COR, M.CD_TAMANHO, M.DT_MOVIM,
		       M.CD_LOJA, 
		       M.QT_PRODUTO * -1 QT_PRODUTO
		  FROM MOVITEM M
		 WHERE M.TP_OPERAC = 'T'
		   AND COALESCE(M.FL_MOVEST,'N') <> 'C'
		 UNION ALL
		SELECT M.CD_PRODUTO, M.CD_COR, M.CD_TAMANHO, M.DT_MOVIM,
			 M.CD_LOJADES CD_LOJA, M.QT_PRODUTO QT_PRODUTO
		  FROM MOVITEM M
		 WHERE M.TP_OPERAC = 'T'
		   AND COALESCE(M.FL_MOVEST,'N') <> 'C' ) M

    ON (M.CD_PRODUTO = P.CD_PRODUTO AND
        COALESCE(M.CD_COR,'') = COALESCE(G.CD_COR,'') AND
        COALESCE(M.CD_TAMANHO,'') = COALESCE(G.CD_TAMANHO,'') )
GROUP BY P.CD_PRODUTO, P.DS_PRODUTO, G.CD_COR, G.CD_TAMANHO, M.DT_MOVIM,
         M.CD_LOJA